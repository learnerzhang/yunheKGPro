var X=Object.defineProperty,Y=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var G=(d,l,a)=>l in d?X(d,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[l]=a,S=(d,l)=>{for(var a in l||(l={}))A.call(l,a)&&G(d,a,l[a]);if(D)for(var a of D(l))W.call(l,a)&&G(d,a,l[a]);return d},M=(d,l)=>Y(d,j(l));var H=(d,l,a)=>new Promise((v,B)=>{var m=y=>{try{b(a.next(y))}catch(T){B(T)}},w=y=>{try{b(a.throw(y))}catch(T){B(T)}},b=y=>y.done?v(y.value):Promise.resolve(y.value).then(m,w);b((a=a.apply(d,l)).next())});import{G as k}from"./index-Duj5iC7n.js";import{a as Z,B as J}from"./index-CfGFDaHn.js";import{g as U,e as q}from"./rule-Rq4WwHG-.js";import{d as K,f as P,c as Q,u as I,Z as O,a4 as ee,a5 as te,$ as oe,_ as ne,a8 as ae,a9 as re}from"./vue-7EN2lk9e.js";const le={class:"p-4 absolute top-0 left-0 right-0 bottom-0 overflow-auto"},pe=K({__name:"RulePreviewModal",setup(d){const l=P(!0),a=P({});let v={};const B=P(null);let m=[];const w=P(!0),b=Q(()=>(I(l),"规则预览")),y=[{operator:">",label:"大于"},{operator:">=",label:"大于等于"},{operator:"=",label:"等于"},{operator:"<",label:"小于"},{operator:"<=",label:"小于等于"}],T=[{connect:"&",label:"且"},{connect:"|",label:"或"}],[R]=Z(t=>H(this,null,function*(){var r;a.value=t==null?void 0:t.record,v.value=null,m=((r=yield U({type:2,page:1,pageSize:1e4}))==null?void 0:r.data)||[];const e=yield q({id:t==null?void 0:t.record.id});v=e!=null&&e.content?z([JSON.parse(e==null?void 0:e.content)])[0]:null,E(v)})),z=t=>(t.forEach(e=>{var r,u,i,f,n,c,p;e.type=="root"?e.name="根节点":e.type=="attr"?e.name=((r=m.find(o=>o.id==e.id))==null?void 0:r.zhName)||"":e.type=="condition"?(e.conditionInfos=((u=e==null?void 0:e.conditionInfos)==null?void 0:u.map(o=>{var s,C,x;return o.connect=((s=T.find(g=>g.connect==o.connect))==null?void 0:s.label)||"",o.operator=((C=y.find(g=>g.operator==o.operator))==null?void 0:C.label)||"",o.judgeType=="select"&&(o.value=((x=m.find(g=>g.id==o.value))==null?void 0:x.zhName)||""),o.valueType=="boolean"&&(o.value=o.value==1?"是":"否"),o}))||[],(i=e.conditionInfos[0])!=null&&i.value&&(e.name=`${((f=e.conditionInfos[0])==null?void 0:f.valueType)!="boolean"&&e.conditionInfos[0].operator||""}${e.conditionInfos[0].value}`||""),(n=e.conditionInfos[1])!=null&&n.value&&(e.name=`${e.name} ${e.conditionInfos[1].connect} ${((c=e.conditionInfos[1])==null?void 0:c.valueType)!="boolean"&&e.conditionInfos[1].operator||""}${e.conditionInfos[1].value}`||"")):e.type=="action"&&(e.name=`${a.value.action}：${e.value}`||""),e.nodeType=e.type,e.collapsed=!1,e.children=e.children||[],delete e.id,delete e.type,(p=e.children)!=null&&p.length&&(e.children=z(e.children))}),t),V=()=>{w.value=!1,setTimeout(()=>{w.value=!0,setTimeout(()=>{E(v)},0)},0)},F={root:"#84868c",attr:"#00c400",condition:"#528eff",action:"#ffab52"},L={data:{},config:{padding:[20,50],defaultLevel:10,defaultZoom:.8,modes:{default:["zoom-canvas","drag-canvas"]}}};let $=0,_=0;const N={width:$,height:_,modes:{default:["zoom-canvas","drag-canvas"]},fitView:!0,maxZoom:1.2,animate:!0,defaultNode:{type:"flow-rect"},defaultEdge:{type:"cubic-horizontal",style:{stroke:"#CED4D9"}},layout:{type:"mindmap",direction:"V",nodeSep:100,rankSep:320,getHeight:()=>40,getWidth:()=>200,getHGap:()=>50,getVGap:()=>40}};(()=>{k.registerNode("flow-rect",{shapeType:"flow-rect",draw(t,e){const{name:r="",collapsed:u,nodeType:i}=t,n={width:250,height:40,lineWidth:1,fontSize:12,fill:"#fff",radius:4,stroke:"#CED4D9",opacity:1},c={x:-n.width/2,y:-n.height/2},p={textAlign:"left",textBaseline:"bottom"},o=e.addShape("rect",{attrs:S({x:c.x,y:c.y},n)}),s=o.getBBox();return e.addShape("text",{attrs:M(S({},p),{x:12+c.x,y:28+c.y,text:r.length>18&&i=="action"?r.substr(0,18)+"...":r,fontSize:12,opacity:.85,fill:"#000",cursor:"pointer"}),name:"name-shape"}),e.addShape("rect",{attrs:{x:c.x,y:c.y,width:4,height:1*s.height,radius:[n.radius,0,0,n.radius],fill:F[i]}}),t.children&&t.children.length&&(e.addShape("rect",{attrs:{x:n.width/2-8,y:-8,width:16,height:16,stroke:"rgba(0, 0, 0, 0.25)",cursor:"pointer",fill:"#fff"},name:"collapse-back",modelId:t.id}),e.addShape("text",{attrs:{x:n.width/2,y:-1,textAlign:"center",textBaseline:"middle",text:u?"+":"-",fontSize:16,cursor:"pointer",fill:"rgba(0, 0, 0, 0.25)"},name:"collapse-text",modelId:t.id})),this.drawLinkPoints(t,e),o},setState(t,e,r){if(t==="collapse"){const i=r.getContainer().find(f=>f.get("name")==="collapse-text");i&&(e?i.attr({text:"+"}):i.attr({text:"-"}))}},getAnchorPoints(){return[[0,.5],[1,.5]]}},"rect"),k.registerEdge("flow-cubic",{getControlPoints(t){let e=t.controlPoints;if(!e||!e.length){const{startPoint:r,endPoint:u,sourceNode:i,targetNode:f}=t,{x:n,y:c,coefficientX:p,coefficientY:o}=i?i.getModel():r,{x:s,y:C}=f?f.getModel():u;let x=(s-n)*p,g=(C-c)*o;x=x>40?40:x,g=g<-30?g:-30,e=[{x:r.x+x,y:r.y},{x:u.x+g,y:u.y}]}return e},getPath(t){const e=[];return e.push(["M",t[0].x,t[0].y]),e.push(["C",t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y]),e}},"single-line")})();let h=null;const E=t=>{if(!t)return;const e=document.getElementById("decisionTreePreview");$=e.scrollWidth,_=e.scrollHeight||500,N.width=$,N.height=_;const{onInit:r,config:u}=L,i=new k.Tooltip({offsetX:20,offsetY:30,itemTypes:["node"],getContent:n=>{const c=document.createElement("div"),p=n.item.getModel().name;let o="";for(let s=0;s<p.length;s++)o=`${o}${p[s]}`,s!==0&&s%20===0&&(o=`${o}<br/>`);return c.innerHTML=`${o}`,c},shouldBegin:n=>n.target.get("name")==="name-shape"});h=new k.TreeGraph(M(S(S({container:"decisionTreePreview"},N),u),{plugins:[i]})),typeof r=="function"&&r(h),h.data(t),h.render(),h.render();const f=n=>{const p=n.target.get("modelId"),o=h.findById(p),s=o.getModel();s.collapsed=!s.collapsed,h.layout(),h.setItemState(o,"collapse",s.collapsed)};h.on("collapse-text:click",n=>{f(n)}),h.on("collapse-back:click",n=>{f(n)})};return(t,e)=>(O(),ee(I(J),re(t.$attrs,{onRegister:I(R),title:b.value,width:"80%",minHeight:600,footer:null,destroyOnClose:!0,bodyStyle:{position:"relative"},onFullscreen:V}),{default:te(()=>[oe("div",le,[w.value?(O(),ne("div",{key:0,ref_key:"decisionTree",ref:B,id:"decisionTreePreview",class:"h-full"},null,512)):ae("",!0)])]),_:1},16,["onRegister","title"]))}});export{pe as _};
