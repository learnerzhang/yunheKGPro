var Sa=Object.defineProperty;var sa=Object.getOwnPropertySymbols;var Ra=Object.prototype.hasOwnProperty,Da=Object.prototype.propertyIsEnumerable;var la=(C,f,d)=>f in C?Sa(C,f,{enumerable:!0,configurable:!0,writable:!0,value:d}):C[f]=d,G=(C,f)=>{for(var d in f||(f={}))Ra.call(f,d)&&la(C,d,f[d]);if(sa)for(var d of sa(f))Da.call(f,d)&&la(C,d,f[d]);return C};var h=(C,f,d)=>new Promise(($,B)=>{var x=n=>{try{T(d.next(n))}catch(b){B(b)}},u=n=>{try{T(d.throw(n))}catch(b){B(b)}},T=n=>n.done?$(n.value):Promise.resolve(n.value).then(x,u);T((d=d.apply(C,f)).next())});import{d as Ea,Y as Oa,f as _,o as Pa,Z as g,a4 as y,a5 as o,$ as j,k as m,u as s,G as N,a8 as k,a3 as Ba,_ as U,B as Ma,y as q,l as O}from"./vue-7EN2lk9e.js";import{P as Na}from"./index-C7IcOeO2.js";import{an as P}from"./entry/index-B-McypeI-1739345778478.js";import{F as A}from"./FormBorder-BUeDstEP.js";import{u as Q,_ as H}from"./useTable-BldcMn6n.js";import"./TableImg.vue_vue_type_style_index_0_lang-2oS39uGR.js";import"./BasicForm.vue_vue_type_style_index_0_lang-qpF-DMKT.js";import{f as $a,p as Ka,i as La,l as ja}from"./task-BVRZM_E3.js";import{n as Fa,o as za}from"./graph-DcHcNpwl.js";import{i as Wa}from"./import.data-89ELN9mQ.js";import{M as Va,bh as Ga,aE as Ua,Q as Y,aF as qa,ah as Aa,aN as Qa,aM as Ha,ay as Ya,bi as Za,ac as ua,W as na,ab as oa,al as ia,ak as Ja,j as Xa}from"./antd-DuSlDOy9.js";import"./useContentViewHeight-B3Yt78Z4.js";import"./useWindowSizeFn-B30U4ulB.js";import"./onMountedOrActivated-8STL9zTa.js";import"./useForm-Hn6EoxrV.js";import"./index-dXxTZxnK.js";import"./sortable.esm-BEDva30o.js";import"./index-BlCAdtVI.js";import"./useSortable-BZ0xEDrO.js";import"./download-CCBYjG8C.js";import"./index-Czo0YvQK.js";import"./copyTextToClipboard-CeRVlT3D.js";const ae={class:"bg-light-50 p-4 mb-4 flex"},ee={class:"flex-1 text-right pt-2"},te=["onClick"],se={key:5,class:"bg-light-50 p-20"},le={key:6,class:"bg-light-50 p-20"},Re=Ea({name:"KgProductImportProcessComponent",__name:"process",setup(C){const[f,d]=Va.useModal(),$=Oa(),{currentRoute:B}=$,x=_(0),u=_({}),T=_([]),n=_(Wa),b=_(""),ra=_(0),D=_(!1),w=_([]),v=_(void 0);let c=_([]),S={},M={},E=[];const[da,{setTableData:pa,setColumns:va}]=Q({title:"数据结果",dataSource:[],columns:E,useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1}),[ca,{setTableData:ga,setColumns:ma}]=Q({columns:E,useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1}),[fa,{setSelectedRowKeys:ka,setTableData:ba,setColumns:ha}]=Q({title:"最终入库数据",columns:[],useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1,rowKey:"id",showSelectionBar:!1,rowSelection:{type:"checkbox"}}),Z=()=>h(this,null,function*(){const t=yield $a({taskid:B.value.query.id});u.value=t||{},c.value=[],D.value=!1,q(()=>h(this,null,function*(){b.value="",x.value=-1,n.value.map(e=>(e.status="",e)),(t==null?void 0:t.task_status)==0&&(x.value=-1,n.value[0].status="",b.value="任务未开始，请开启任务。"),(t==null?void 0:t.task_status)==1&&(x.value=0,n.value[0].status="process",b.value="数据装载执行中，请耐心等待。"),(t==null?void 0:t.task_status)==2&&(x.value=0,n.value[0].status="finish",yield J()),(t==null?void 0:t.task_status)==3&&(x.value=1,n.value[0].status="finish",n.value[1].status="process",b.value="实体比对执行中，请耐心等待。"),(t==null?void 0:t.task_status)==4&&(x.value=1,n.value[0].status="finish",n.value[1].status="finish",yield ya()),(t==null?void 0:t.task_status)==5&&(x.value=3,n.value[0].status="finish",n.value[1].status="finish",n.value[2].status="finish",n.value[3].status="finish"),(t==null?void 0:t.task_status)==10&&(b.value="图谱构建中，请耐心等待。",x.value=2,n.value[0].status="finish",n.value[1].status="finish",n.value[2].status="finish")}))}),J=(t="load")=>h(this,null,function*(){c.value=[],w.value=[],v.value=void 0,S=(yield Fa({taskId:B.value.query.id}))||{},M={},w.value=Object.keys(S).map(a=>(M[a]=S[a].map(i=>i.id),{label:a,value:a}))||[],w.value.length>0&&(v.value=w.value[0].value,F(t))}),ya=()=>h(this,null,function*(){c.value=[],w.value=[],v.value=void 0,S=(yield za({taskId:B.value.query.id}))||{},w.value=Object.keys(S).map(e=>({label:e,value:e}))||[],w.value.length>0&&(v.value=w.value[0].value,F("simlar"))}),F=t=>{var e;c.value=[],E=[],T.value=[],(e=S[v.value])==null||e.map(a=>{var V,X,aa,ea;a.replaceId&&T.value.push(a.id);let i=((V=a==null?void 0:a.attrNames)==null?void 0:V.map(r=>({title:r,dataIndex:r})))||[];const p=(a==null?void 0:a.attValues)||{};if(p.id=a.id,p.tags=(a==null?void 0:a.tags)||[],i.push({title:"标签",dataIndex:"tags",customRender:({record:r})=>O(ia,{wrap:!0,size:["small","small"],align:"center"},{default:()=>r==null?void 0:r.tags.map(I=>O(oa,{color:"processing"},I.name))})}),Object.keys(a.groupRelations||{}).map(r=>{i.push({title:r,dataIndex:r}),p[r]=a.groupRelations[r]}),p.名称=a.name,i=[{title:"名称",dataIndex:"名称"},...i],p.replaceId=a.replaceId||"",p.subColumns=[],p.subTableData=[],t=="simlar"){let r=[],I={};(X=a==null?void 0:a.siments)==null||X.map(l=>{var L,ta;(L=l==null?void 0:l.attlist)==null||L.map(R=>{I[R.attname]=R.atttvalue}),I.id=l.id,I.sim=Number((l.sim*100).toFixed(2))+"%",I.tags=(l==null?void 0:l.taglist)||[],((ta=l==null?void 0:l.relations)==null?void 0:ta.length)>0&&(l==null||l.relations.map(R=>{I[R.rel]=R.toNodeName})),Object.keys(l.groupRelations||{}).map(R=>{I[R]=l.groupRelations[R]}),I.名称=l.name}),(ea=(aa=a==null?void 0:a.siments[0])==null?void 0:aa.attlist)==null||ea.map(l=>{r.push({ellipsis:!0,align:"center",minWidth:150,title:l.attname,dataIndex:l.attname})}),r.push({title:"标签",dataIndex:"tags",ellipsis:!0,align:"center",minWidth:150,customRender:({record:l})=>O(ia,{wrap:!0,size:["small","small"],align:"center"},{default:()=>l==null?void 0:l.tags.map(L=>O(oa,{color:"processing"},L.name))})}),Object.keys(a.siments[0].groupRelations||{}).map(l=>{r.push({title:l,dataIndex:l,align:"center",minWidth:150,ellipsis:!0})}),r=[{title:"名称",dataIndex:"名称",align:"center",minWidth:150,ellipsis:!0},...r,{title:"相似度",dataIndex:"sim",align:"center",fixed:"right",width:80},{title:"是否覆盖",dataIndex:"operation",align:"center",fixed:"right",width:80}],p.subColumns=[...r],p.subTableData.push(G({},I))}c.value.push(G({},p)),ra.value=c.value.length,E=[...i]}),q(()=>{t=="load"?(pa(c.value),va(E)):t=="simlar"?(ga(c.value),ma(E)):t=="product"&&(ba(c.value),ha(E),ka(M[v.value]))})},z=(t,e)=>{v.value=t,F(e)},xa=({keys:t})=>{M[v.value]=t};Pa(()=>{Z()});let W={};const Ta=()=>h(this,null,function*(){if(u.value.task_status==2&&(yield Ka({task_id:u.value.id}),K()),u.value.task_status==4&&!D.value){W={},Object.keys(S).forEach(t=>{S[t].forEach(e=>{e.replaceId&&(W[e.id]=e.replaceId)})}),D.value=!0,q(()=>h(this,null,function*(){yield J("product")}));return}if(u.value.task_status==4&&D.value){let t=[];Object.keys(M).map(e=>{t=[...t,...M[e]]}),t=Array.from(new Set(t)),f.confirm({title:`你选择了${t.length}条数据，你确定入库吗?`,icon:O(Ja),okButtonProps:{class:"p-0 border-0 bg-transparent"},cancelButtonProps:{class:"p-0 border-0 bg-transparent"},okText:O(P,{type:"primary",class:"pl-2 pr-2"},"确认入库"),cancelText:O(P,{type:"default",class:"pl-2 pr-2"},"取消"),confirmLoading:!1,onOk:()=>h(this,null,function*(){yield La({task_id:u.value.id,ent_ids:t,replace_id_pairs:W||{}}),K()}),onCancel(){}})}}),K=()=>h(this,null,function*(){yield Z()}),wa=()=>h(this,null,function*(){yield ja({task_id:u.value.id,force:0}),K()}),Ca=()=>h(this,null,function*(){yield K(),Xa.success("获取最新状态成功")}),Ia=t=>{const e=t.id,a=T.value.indexOf(e),i=[...T.value];a>-1?i.splice(a,1):i.push(e),T.value=i},_a=(t,e)=>h(this,null,function*(){const{id:a}=e;t.replaceId=t.replaceId===a?"":a;const i=c.value.findIndex(p=>p.id===t.id);c.value[i].replaceId=t.replaceId,S[v.value][i].replaceId=t.replaceId});return(t,e)=>(g(),y(s(Na),{title:u.value.name,content:u.value.desc},{default:o(()=>[j("div",null,[j("div",ae,[m(s(Ga),{current:x.value,type:"navigation",class:"w-2/3",responsive:!1,items:n.value},null,8,["current","items"]),j("div",ee,[u.value.task_status!=5&&u.value.task_status!=10?(g(),y(s(P),{key:0,disabled:!!b.value,type:"primary",size:"large",class:"w-28",onClick:e[0]||(e[0]=a=>Ta())},{default:o(()=>e[12]||(e[12]=[N(" 下一步 ")])),_:1},8,["disabled"])):k("",!0)])]),b.value?(g(),y(s(Ua),{key:0,type:"error",class:"mb-4"},{message:o(()=>[j("div",null,[N(Ba(b.value)+" ",1),u.value.task_status==0?(g(),y(s(P),{key:0,onClick:e[1]||(e[1]=a=>wa()),type:"link",size:"small",class:"ml-2"},{default:o(()=>e[13]||(e[13]=[N(" 立即执行 ")])),_:1})):k("",!0),u.value.task_status==1||u.value.task_status==3||u.value.task_status==10?(g(),y(s(P),{key:1,onClick:e[2]||(e[2]=a=>Ca()),type:"link",size:"small",class:"ml-2"},{default:o(()=>e[14]||(e[14]=[N(" 查询最新状态 ")])),_:1})):k("",!0)])]),_:1})):k("",!0),(u.value.task_status==1||u.value.task_status==2)&&s(c).length>0?(g(),y(s(H),{key:1,onRegister:s(da)},{toolbar:o(()=>[m(s(A),null,{default:o(()=>[m(s(Y),{options:w.value,value:v.value,"onUpdate:value":e[3]||(e[3]=a=>v.value=a),class:"w-40",onChange:e[4]||(e[4]=a=>z(a,"load"))},null,8,["options","value"])]),_:1})]),_:1},8,["onRegister"])):k("",!0),(u.value.task_status==3||u.value.task_status==4&&!D.value)&&s(c).length>0?(g(),y(s(H),{key:2,class:"similar-table",onRegister:s(ca),expandedRowKeys:T.value,"onUpdate:expandedRowKeys":e[7]||(e[7]=a=>T.value=a),striped:!1,pagination:!1,title:"相似比对结果",rowKey:"id"},{toolbar:o(()=>[m(s(A),null,{default:o(()=>[m(s(Y),{options:w.value,value:v.value,"onUpdate:value":e[5]||(e[5]=a=>v.value=a),class:"w-40",onChange:e[6]||(e[6]=a=>z(a,"simlar"))},null,8,["options","value"])]),_:1})]),expandedRowRender:o(({record:a})=>[m(s(qa),{dataSource:a.subTableData,showIndexColumn:"",columns:a.subColumns,pagination:!1,bordered:"",size:"small",scroll:{x:1300}},{bodyCell:o(({column:i,record:p})=>[i.dataIndex=="operation"?(g(),y(s(Aa),{key:0,checked:a.replaceId==p.id,onChange:V=>_a(a,p)},{checkedChildren:o(()=>[m(s(Qa))]),unCheckedChildren:o(()=>[m(s(Ha))]),_:2},1032,["checked","onChange"])):k("",!0)]),_:2},1032,["dataSource","columns"])]),expandIcon:o(({record:a,expanded:i})=>[a.subTableData.length>0?(g(),U("div",{key:0,class:"text-center cursor-pointer text-gray-700",onClick:Ma(p=>Ia(a),["stop"])},[i?k("",!0):(g(),y(s(Ya),{key:0})),i?(g(),y(s(Za),{key:1})):k("",!0)],8,te)):k("",!0)]),_:1},8,["onRegister","expandedRowKeys"])):k("",!0),(u.value.task_status==3||u.value.task_status==4&&!D.value)&&s(c).length==0?(g(),y(s(ua),{key:3,class:"mt-30",image:s(ua).PRESENTED_IMAGE_SIMPLE,description:"暂无相似数据"},null,8,["image"])):k("",!0),u.value.task_status==4&&D.value&&s(c).length>0?(g(),y(s(H),{key:4,onRegister:s(fa),striped:!1,onSelectionChange:xa},{toolbar:o(()=>[m(s(A),null,{default:o(()=>[m(s(Y),{options:w.value,value:v.value,"onUpdate:value":e[8]||(e[8]=a=>v.value=a),class:"w-40",onChange:e[9]||(e[9]=a=>z(a,"product"))},null,8,["options","value"])]),_:1})]),_:1},8,["onRegister"])):k("",!0),u.value.task_status==10?(g(),U("div",se,[m(s(na),{status:"info",title:"图谱构建中",subTitle:"图谱构建中，请耐心等候。"},{extra:o(()=>[m(s(P),{onClick:e[10]||(e[10]=a=>s($).push("/graph-manage/product/import"))},{default:o(()=>e[15]||(e[15]=[N("返回图谱列表")])),_:1})]),_:1})])):k("",!0),u.value.task_status==5?(g(),U("div",le,[m(s(na),{status:"success",title:"构建完成",subTitle:"图谱构建已完成，请前往查看结果。"},{extra:o(()=>[m(s(P),{onClick:e[11]||(e[11]=a=>s($).push("/graph-manage/product/import"))},{default:o(()=>e[16]||(e[16]=[N("返回图谱列表")])),_:1})]),_:1})])):k("",!0)]),m(s(d))]),_:1},8,["title","content"]))}});export{Re as default};
