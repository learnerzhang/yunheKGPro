var ae=Object.defineProperty,te=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var le=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var E=(u,r,i)=>r in u?ae(u,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):u[r]=i,I=(u,r)=>{for(var i in r||(r={}))le.call(r,i)&&E(u,i,r[i]);if(M)for(var i of M(r))oe.call(r,i)&&E(u,i,r[i]);return u},R=(u,r)=>te(u,se(r));var k=(u,r,i)=>new Promise((S,C)=>{var v=l=>{try{f(i.next(l))}catch(p){C(p)}},t=l=>{try{f(i.throw(l))}catch(p){C(p)}},f=l=>l.done?S(l.value):Promise.resolve(l.value).then(v,t);f((i=i.apply(u,r)).next())});import{d as ie,Y as re,f as y,o as ne,Z as n,a4 as m,a5 as d,$ as B,k as h,u as s,G as x,a8 as c,a3 as ue,_ as N,B as de,y as q,l as $}from"./vue-7EN2lk9e.js";import{P as ce}from"./index-Fa5FDUAc.js";import{an as b}from"./entry/index-gwXb_KLU-1735894345864.js";import{u as D,_ as O}from"./useTable-dUUy5G55.js";import"./TableImg.vue_vue_type_style_index_0_lang-B8XoVYjR.js";import"./BasicForm.vue_vue_type_style_index_0_lang-BdxNsio9.js";import{e as z,b as pe,f as me,p as ve,h as ke,l as fe}from"./task-DJafqcAW.js";import{i as ge,l as A,s as ye,a as he}from"./import.data-DhkZBgAz.js";import{M as _e,bh as be,aE as we,aF as xe,ah as Se,aN as Ce,aM as Te,ay as Ie,bi as Re,W as Be,ak as Pe,j as Fe}from"./antd-DuSlDOy9.js";import"./useContentViewHeight-DsKchgvx.js";import"./useWindowSizeFn-CiLeeFbn.js";import"./onMountedOrActivated-8STL9zTa.js";import"./useForm-aNhbSFae.js";import"./FormBorder-B3cKGDVh.js";import"./index-C6GdxVlT.js";import"./sortable.esm-BEDva30o.js";import"./index-Bv_21ZiX.js";import"./useSortable-Cwu1FJTc.js";import"./download-DrMjnooB.js";import"./index-K2-6QmFf.js";import"./copyTextToClipboard-CeRVlT3D.js";const $e={class:"bg-light-50 p-4 mb-4 flex"},De={class:"flex-1 text-right pt-2"},Oe=["onClick"],Ke={key:4,class:"bg-light-50 p-20"},oa=ie({name:"KgProductImportProcessComponent",__name:"process",setup(u){const[r,i]=_e.useModal(),S=re(),{currentRoute:C}=S,v=y(0),t=y({}),f=y([]),l=y(ge),p=y(""),P=y(0),_=y(!1),[L,{reload:V}]=D({title:"数据装载结果",api:z,columns:A,beforeFetch:e=>R(I({},e),{taskId:t.value.id,docId:t.value.kg_doc_id}),fetchSetting:{listField:"data"},useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1}),[Q,{reload:W,getDataSource:j}]=D({api:pe,columns:ye,beforeFetch:e=>R(I({},e),{pageSize:99999,taskId:t.value.id}),afterFetch:e=>(P.value=e.length,e.map(a=>(a.replaceId="",a)),e),useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1}),[G,{reload:H,getSelectRowKeys:U}]=D({title:"最终入库数据",api:z,columns:A,beforeFetch:e=>R(I({},e),{taskId:t.value.id,docId:t.value.kg_doc_id}),fetchSetting:{listField:"data"},useSearchForm:!1,showTableSetting:!0,bordered:!0,showIndexColumn:!0,immediate:!1,rowKey:"id",showSelectionBar:!0,rowSelection:{type:"checkbox"}}),K=()=>k(this,null,function*(){const e=yield me({taskid:C.value.query.id});t.value=e||{},_.value=!1,q(()=>k(this,null,function*(){p.value="",v.value=-1,l.value.map(a=>(a.status="",a)),(e==null?void 0:e.task_status)==0&&(v.value=-1,l.value[0].status="",p.value="任务未开始，请开启任务。"),(e==null?void 0:e.task_status)==1&&(v.value=0,l.value[0].status="process",p.value="装载任务执行中，请耐心等待。"),(e==null?void 0:e.task_status)==2&&(v.value=0,l.value[0].status="finish",yield V()),(e==null?void 0:e.task_status)==3&&(v.value=1,l.value[0].status="finish",l.value[1].status="process",p.value="比对任务执行中，请耐心等待。"),(e==null?void 0:e.task_status)==4&&(v.value=1,l.value[0].status="finish",l.value[1].status="finish",yield W()),(e==null?void 0:e.task_status)==5&&(v.value=2,l.value[0].status="finish",l.value[1].status="finish",l.value[2].status="finish")}))});ne(()=>{K()});let w=[];const Y=()=>k(this,null,function*(){if(t.value.task_status==2&&(yield ve({task_id:t.value.id}),T()),t.value.task_status==4&&!_.value){w=[],j().forEach(a=>{a.replaceId&&w.push(a.replaceId)}),w=Array.from(new Set(w)),_.value=!0,q(()=>k(this,null,function*(){H()}));return}if(t.value.task_status==4&&_.value){let e=U();e=Array.from(new Set(e)),r.confirm({title:`你选择了${e.length}条数据，你确定入库吗?`,icon:$(Pe),okButtonProps:{class:"p-0 border-0 bg-transparent"},cancelButtonProps:{class:"p-0 border-0 bg-transparent"},okText:$(b,{type:"primary",class:"pl-2 pr-2"},"确认入库"),cancelText:$(b,{type:"default",class:"pl-2 pr-2"},"取消"),confirmLoading:!1,onOk:()=>k(this,null,function*(){yield ke({task_id:t.value.id,qa_ids:e,replace_qa_ids:w}),T()}),onCancel(){}})}}),T=()=>k(this,null,function*(){yield K()}),Z=()=>k(this,null,function*(){yield fe({task_id:t.value.id,force:0}),T()}),J=()=>k(this,null,function*(){yield T(),Fe.success("获取最新状态成功")}),X=e=>{const a=e.key,o=f.value.indexOf(a),g=[...f.value];o>-1?g.splice(o,1):g.push(a),f.value=g},ee=(e,a)=>k(this,null,function*(){const{id:o}=a;e.replaceId=e.replaceId===o?"":o});return(e,a)=>(n(),m(s(ce),{title:t.value.name,content:t.value.desc},{default:d(()=>[B("div",null,[B("div",$e,[h(s(be),{current:v.value,type:"navigation",class:"w-1/2",responsive:!1,items:l.value},null,8,["current","items"]),B("div",De,[t.value.task_status!=5?(n(),m(s(b),{key:0,disabled:!!p.value,type:"primary",size:"large",class:"w-28",onClick:a[0]||(a[0]=o=>Y())},{default:d(()=>a[5]||(a[5]=[x(" 下一步 ")])),_:1},8,["disabled"])):c("",!0)])]),p.value?(n(),m(s(we),{key:0,type:"error",class:"mb-4"},{message:d(()=>[B("div",null,[x(ue(p.value)+" ",1),t.value.task_status==0?(n(),m(s(b),{key:0,onClick:a[1]||(a[1]=o=>Z()),type:"link",size:"small",class:"ml-2"},{default:d(()=>a[6]||(a[6]=[x(" 立即执行 ")])),_:1})):c("",!0),t.value.task_status==1||t.value.task_status==3?(n(),m(s(b),{key:1,onClick:a[2]||(a[2]=o=>J()),type:"link",size:"small",class:"ml-2"},{default:d(()=>a[7]||(a[7]=[x(" 查询最新状态 ")])),_:1})):c("",!0)])]),_:1})):c("",!0),t.value.task_status==1||t.value.task_status==2?(n(),m(s(O),{key:1,onRegister:s(L)},null,8,["onRegister"])):c("",!0),t.value.task_status==3||t.value.task_status==4&&!_.value?(n(),m(s(O),{key:2,class:"similar-table",onRegister:s(Q),expandedRowKeys:f.value,"onUpdate:expandedRowKeys":a[3]||(a[3]=o=>f.value=o),striped:!1,pagination:!1,title:`相似比对结果${P.value>0?"（共 "+P.value+" 条）":""}`},{expandedRowRender:d(({record:o})=>[h(s(xe),{dataSource:o.simqas,showIndexColumn:"",columns:s(he),pagination:!1,bordered:"",size:"small"},{bodyCell:d(({column:g,record:F})=>[g.dataIndex=="operation"?(n(),m(s(Se),{key:0,checked:o.replaceId==F.id,onChange:Me=>ee(o,F)},{checkedChildren:d(()=>[h(s(Ce))]),unCheckedChildren:d(()=>[h(s(Te))]),_:2},1032,["checked","onChange"])):c("",!0)]),_:2},1032,["dataSource","columns"])]),expandIcon:d(({record:o,expanded:g})=>[o.simqas.length>0?(n(),N("div",{key:0,class:"text-center cursor-pointer text-gray-700",onClick:de(F=>X(o),["stop"])},[g?c("",!0):(n(),m(s(Ie),{key:0})),g?(n(),m(s(Re),{key:1})):c("",!0)],8,Oe)):c("",!0)]),_:1},8,["onRegister","expandedRowKeys","title"])):c("",!0),t.value.task_status==4&&_.value?(n(),m(s(O),{key:3,onRegister:s(G),striped:!1},null,8,["onRegister"])):c("",!0),t.value.task_status==5?(n(),N("div",Ke,[h(s(Be),{status:"success",title:"生产完成",subTitle:"任务已完成，请前往查看结果。"},{extra:d(()=>[h(s(b),{onClick:a[4]||(a[4]=o=>s(S).push("/kg-product/import"))},{default:d(()=>a[8]||(a[8]=[x("返回任务列表")])),_:1})]),_:1})])):c("",!0)]),h(s(i))]),_:1},8,["title","content"]))}});export{oa as default};
