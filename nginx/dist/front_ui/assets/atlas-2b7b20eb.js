import{i as C}from"./index-20c3ceee.js";import{r as p}from"./index-2452f0fe.js";import{_ as L,b as D,c,d as f,e as r,f as y,n as k,q as S,t as d,g as x,j as m,F as E,i as v}from"./index-734ed102.js";import"./tslib.es6-7c8db84e.js";const b=async s=>await p.getData({url:"kgapp/graphExpand",params:s}),I=async s=>await p.getData({url:"kgapp/graph",params:s}),_=async s=>await p.get({url:"kgapp/graphEntity/detailByNameType",params:s}),N=async s=>await p.getData({url:"kgapp/graphEntityScheme",params:s}),z=async s=>await p.getData({url:"kgapp/task",params:s}),T=""+new URL("tit-4415a57d.png",import.meta.url).href;const F={data(){return{atlasChart:null,EchartsData:{nodes:[],links:[],categories:[]},showNode:[],windowsSizeTimer:null,nowNodeInfo:null,nodeDetailsShow:!1,nodeDetailsData:null,searchList:null,searchQuery:"",showList:!1,taskKeyId:null,taskList:[]}},computed:{filteredItems(){if(!this.searchQuery)return this.searchList;const s=this.searchQuery.toLowerCase();return this.showList=!0,this.searchList.filter(e=>e.name.toLowerCase().includes(s))}},watch:{nodeDetailsShow(){this.$nextTick(()=>{setTimeout(()=>{this.atlasChart.resize()},100)})}},mounted(){this.getGraphTask(),this.EchartsInit(),window.addEventListener("resize",this.handleResize)},beforeDestroy(){window.removeEventListener("resize",this.handleResize)},methods:{handleSelect(s){this.changeGraph(s.name)},querySearch(s,e){var a=this.searchList,o=s?a.filter(this.createFilter(s)):a;e(o)},createFilter(s){return e=>e.value.toLowerCase().indexOf(s.toLowerCase())===0},getGraphEntityScheme(){const s={page:1,pageSize:1e3,taskId:this.taskKeyId};N(s).then(e=>{this.searchList=e.data,this.searchList.map(a=>{a.value=a.name})})},handleResize(){this.windowsSizeTimer&&clearTimeout(this.windowsSizeTimer),this.windowsSizeTimer=setTimeout(()=>{this.atlasChart.resize()},300)},changeGraph(s){const e=this.atlasChart.getOption();let a=e.series[0].nodes.map(i=>i.name),o=null;if(a.includes(s))o=e.series[0].nodes.map(i=>i.name===s?{...i,itemStyle:{}}:{...i,itemStyle:{opacity:.2}});else return;const t={...e,series:[{...e.series[0],nodes:o}]};this.atlasChart.setOption(t)},EchartsInit(){function s(a){var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null}function e(a,o){if(a.startsWith("#")){var t=s(a);return`rgba(${t.r}, ${t.g}, ${t.b}, ${o})`}else if(a.startsWith("rgb(")){var i=a.match(/\d+/g);return`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${o})`}else return a}this.atlasChart=C(this.$refs.atlasChart),this.atlasChart.setOption({series:[{type:"graph",roam:!0,scaleLimit:{min:.6},animation:!1,animationDuration:0,draggable:!0,layout:"force",force:{repulsion:1e3,edgeLength:200,friction:.2},itemStyle:{borderColor:"transparent",borderWidth:1},label:{fontSize:12,color:"#000",fontFamily:"PingFang SC",normal:{show:!0,formatter:function(a){return a.data.name.length>4?a.data.name.substr(0,4)+"...":a.data.name}},emphasis:{show:!0,formatter:"{b}",overflow:"break",lineHeight:15,itemStyle:{borderColor:function(a){var o=a.color;return e(o,.5)},borderWidth:10}}},edgeLabel:{show:!0,fontSize:12,fontWeight:900,lineHeight:15,fontFamily:"PingFang SC",color:"#adadadeb",formatter:a=>a.value},lineStyle:{opacity:1,width:2,color:"#adadadeb"},edgeSymbol:["none","arrow"],edgeSymbolSize:8,nodes:[],links:[]}]}),this.atlasChart.on("click",a=>{event.stopPropagation(),a.dataType=="node"&&(this.nowNodeInfo={type:a.data.category,name:a.data.name,id:a.data.nodeid,x:a.event.offsetX,y:a.event.offsetY})}),this.atlasChart.getZr().on("click",a=>{if(event.stopPropagation(),!a.target){this.nowNodeInfo=null,this.searchQuery="";const o=this.atlasChart.getOption(),t=o.series[0].nodes.map(n=>({...n,itemStyle:{opacity:1}})),i={...o,series:[{...o.series[0],nodes:t}]};this.atlasChart.setOption(i)}})},dataItemStyle(s,e,a){return{color:{type:"radial",x:.5,y:.5,r:.4,globalCoord:!1,colorStops:[{offset:0,color:s},{offset:1,color:e}]},borderColor:a,borderWidth:6,borderType:"solid"}},indexColorGET(s,e){let a=[["#EA8C82","#E46A5E","#D3C8DA"],["#E2B0AA","#EA9E8C","#D4D4E4"],["#EACD92","#F3C263","#D9DCDC"],["#AECCD7","#A4C6CB","#C2D7EF"],["#C48ABB","#C46FA5","#C9C7E9"],["#E3CFCD","#EDCABE","#CDD7EF"],["#B7D8F7","#B2D7F5","#D0E3FB"],["#A8DEE8","#9CDCE2","#BFDCF6"]],o=[{level:0,size:110},{level:1,size:70}],t=e>1?["#8CC5FF","#66B1FF","#B3D8FF"]:a[s],i=e>1?76:o.filter(n=>n.level==e)[0].size;return{color:t,size:i}},update(){this.EchartsData.nodes.forEach((e,a)=>{let o=this.indexColorGET(a,e.level);e.symbolSize=o.size,e.label={width:o.size-10}});let s=this.atlasChart.getOption();s.series[0].nodes=this.EchartsData.nodes,s.series[0].links=this.EchartsData.links,s.series[0].categories=this.EchartsData.categories,this.searchList=this.EchartsData.nodes,this.searchList.map(e=>{e.value=e.name}),this.atlasChart.setOption(s)},sonNodesGET(s,e){let a=[];return s.forEach(o=>{o.source==e&&(a.push(o.target),a=a.concat(this.sonNodesGET(s,o.target)))}),a},nodesHandle(s,e,a=!0){if(a)this.nodesGET(s,e);else{this.nodeDetailsShow=!1;let o=this.showNode.findIndex(l=>l==s);this.showNode.splice(o,1);let t=this.sonNodesGET(this.EchartsData.links,s),i=this.EchartsData.nodes.filter(l=>!t.includes(l.name)),n=this.EchartsData.links.filter(l=>!t.includes(l.target)),g=this.EchartsData.nodes.filter(l=>l.name==s)[0].level;this.showNode.forEach((l,h)=>{this.EchartsData.nodes.filter(w=>w.name==l)[0].level>g&&(this.showNode=this.showNode.filter(w=>w!=l))}),this.EchartsData.nodes=i,this.searchList=i,this.searchList.map(l=>{l.value=l.name}),this.EchartsData.links=n,this.update()}},filterBidirectionalLinks(s){const e=new Map,a=[];return s.forEach(o=>{const t=`${o.source}-${o.target}`,i=`${o.target}-${o.source}`;!e.has(t)&&!e.has(i)&&(a.push(o),e.set(t,!0))}),a},nodesGET(s,e){if(this.$refs.Load.showLoad(!0,"获取数据..."),e){let o={name:e.name,type:e.type,taskId:this.taskKeyId};b(o).then(t=>{this.EchartsData.categories=t.categories,this.$refs.Load.showLoad(!1),t.nodes.length>0?this.showNode.push(s):this.$refs.Hint.showHint(s+"没有其他子节点了"),t.nodes.forEach(i=>{s=="乌海市取水许可知识图谱"?i.level=1:i.level=this.EchartsData.nodes.filter(n=>n.name==s)[0].level+1,i.name=="乌海市取水许可知识图谱"&&(i.level=0),this.EchartsData.nodes.some(n=>n.name===i.name)||this.EchartsData.nodes.push(i)}),t.links.forEach(i=>{this.EchartsData.links.some(n=>n.target===i.target)||this.EchartsData.links.push(i),t.nodes.forEach(function(n){i.target==n.nodeid&&(i.target=n.name),i.source==n.nodeid&&(i.source=n.name)})}),this.EchartsData.links=this.filterBidirectionalLinks(this.EchartsData.links),this.update()});return}const a={taskId:this.taskKeyId,total:1e3};I(a).then(o=>{this.searchList=o.nodes,this.searchList.map(t=>{t.value=t.name}),this.EchartsData.categories=o.categories,this.$refs.Load.showLoad(!1),o.nodes.length>0?this.showNode.push(s):this.$refs.Hint.showHint(s+"没有其他子节点了"),o.nodes.forEach(t=>{s=="乌海市取水许可知识图谱"?t.level=1:t.level=this.EchartsData.nodes.filter(i=>i.name==s)[0].level+1,t.name=="乌海市取水许可知识图谱"&&(t.level=0),this.EchartsData.nodes.some(i=>i.name===t.name)||this.EchartsData.nodes.push(t)}),o.links.forEach(t=>{this.EchartsData.links.some(i=>i.target===t.target)||this.EchartsData.links.push(t),o.nodes.forEach(function(i){t.target==i.nodeid&&(t.target=i.name),t.source==i.nodeid&&(t.source=i.name)})}),this.update()}).catch(o=>{this.$refs.Load.showLoad(!1),this.$refs.Hint.showHint("获取数据失败")})},nodeDetails(s){this.$refs.Load.showLoad(!0,"获取数据...");let e={taskId:this.taskKeyId,name:s.name,type:s.type};_(e).then(a=>{this.$refs.Load.showLoad(!1),this.nodeDetailsData=a,this.nodeDetailsShow=!0}).catch(a=>{this.$refs.Load.showLoad(!1),this.$refs.Hint.showHint("获取实体详情失败")})},getGraphTask(){z({taskType:3,status:5}).then(e=>{this.taskList=e.data,this.taskList.length>0&&(this.taskKeyId=this.taskList[0].id,this.nodesHandle("乌海市取水许可知识图谱"))})},selectTaskList(s){this.taskKeyId=s,this.EchartsData={nodes:[],links:[],categories:[]},this.nodesHandle("乌海市取水许可知识图谱")}}},B={class:"search-box z-index w-20% h-200px position-absolute"},H={class:"position-relative"},A={class:"title"},G={class:"type"},O={class:"handle"},K={key:1,class:"nodeDetails"},R={class:"typeText"},V={class:"list"},$={class:"flex items-baseline mb-15px"},Q={class:"flex-1 f-3"},W={class:"text-gray-400 mr-20px f-blue"},q={class:"flex-1 f-3"},P={class:"text-gray-400 mr-20px f-blue"},M={class:"flex-1 f-3"};function U(s,e,a,o,t,i){const n=D("el-autocomplete"),g=D("Load"),l=D("Hint");return c(),f("div",{class:"container-atlas flex",onClick:e[4]||(e[4]=h=>t.nowNodeInfo=null)},[r("div",B,[e[5]||(e[5]=r("div",{class:"title-box"}," 图谱探索 ",-1)),r("div",H,[y(n,{class:"inline-input",icon:"el-icon-search",modelValue:t.searchQuery,"onUpdate:modelValue":e[0]||(e[0]=h=>t.searchQuery=h),"fetch-suggestions":i.querySearch,placeholder:"请输入内容","trigger-on-focus":!1,onSelect:i.handleSelect},null,8,["modelValue","fetch-suggestions","onSelect"])])]),r("div",{id:"graphId",class:k(["atlasChart w-80%",{atlasChartSize:t.nodeDetailsShow}]),ref:"atlasChart"},null,2),y(g,{ref:"Load"},null,512),y(l,{ref:"Hint"},null,512),t.nowNodeInfo?(c(),f("div",{key:0,class:"nowNodeInfo",style:S({left:t.nowNodeInfo.x+"px",top:t.nowNodeInfo.y+"px"})},[r("div",A,d(t.nowNodeInfo.name),1),r("div",G,[e[6]||(e[6]=x("类型 : ")),r("span",null,d(t.nowNodeInfo.type),1)]),r("div",O,[r("li",{onClick:e[1]||(e[1]=h=>i.nodeDetails(t.nowNodeInfo))},"实体详情"),r("li",{onClick:e[2]||(e[2]=h=>i.nodesHandle(t.nowNodeInfo.name,t.nowNodeInfo,!t.showNode.includes(t.nowNodeInfo.name)))},d(t.showNode.includes(t.nowNodeInfo.name)?"隐藏子节点":"显示子节点"),1),e[7]||(e[7]=r("li",null,"取消",-1))])],4)):m("",!0),t.nodeDetailsShow?(c(),f("div",K,[r("div",{class:"fold",onClick:e[3]||(e[3]=h=>t.nodeDetailsShow=!1)},e[8]||(e[8]=[r("span",{class:"iconfont"},"",-1)])),r("div",R,[e[10]||(e[10]=r("div",{class:"title"},[r("img",{src:T}),r("i",null,d("节点信息"))],-1)),r("div",V,[r("div",$,[e[9]||(e[9]=r("div",{class:"text-gray-400 mr-20px f-blue"},"名称:",-1)),r("div",Q,d(t.nodeDetailsData.name),1)]),String(t.nodeDetailsData.groupRelations)!="{}"?(c(!0),f(E,{key:0},v(t.nodeDetailsData.groupRelations||{},(h,u)=>(c(),f("div",{class:"flex items-baseline",key:u+"relations"},[r("div",W,d(u),1),r("div",q,d(h),1)]))),128)):m("",!0),t.nodeDetailsData.attlist.length>0?(c(!0),f(E,{key:1},v(t.nodeDetailsData.attlist,(h,u)=>(c(),f("div",{key:u,class:"flex items-baseline mb-15px"},[r("div",P,d(h.attname)+":",1),r("div",M,d(h.atttvalue),1)]))),128)):m("",!0)])])])):m("",!0)])}const J=L(F,[["render",U],["__scopeId","data-v-dd21606a"]]);export{J as default};
