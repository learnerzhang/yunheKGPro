import{i as L}from"./index-20c3ceee.js";import{r as p}from"./index-ef4e74fa.js";import{_ as k,b as f,c as d,d as u,e as n,f as g,n as x,q as b,t as c,g as S,j as w,F as y,i as E,w as _,x as I}from"./index-fd06f363.js";import"./tslib.es6-7c8db84e.js";const N=async s=>await p.getData({url:"kgapp/graphExpand",params:s}),T=async s=>await p.getData({url:"kgapp/graph",params:s}),z=async s=>await p.get({url:"kgapp/graphEntity/detailByNameType",params:s}),F=async s=>await p.getData({url:"kgapp/graphEntityScheme",params:s}),B=async s=>await p.getData({url:"kgapp/task",params:s}),H=""+new URL("tit-4415a57d.png",import.meta.url).href;const A={data(){return{atlasChart:null,EchartsData:{nodes:[],links:[],categories:[]},showNode:[],windowsSizeTimer:null,nowNodeInfo:null,nodeDetailsShow:!1,nodeDetailsData:null,searchList:null,searchQuery:"",showList:!1,taskKeyId:null,taskList:[]}},computed:{filteredItems(){if(!this.searchQuery)return this.searchList;const s=this.searchQuery.toLowerCase();return this.showList=!0,this.searchList.filter(e=>e.name.toLowerCase().includes(s))}},watch:{nodeDetailsShow(){this.$nextTick(()=>{setTimeout(()=>{this.atlasChart.resize()},100)})}},mounted(){this.getGraphTask(),this.EchartsInit(),window.addEventListener("resize",this.handleResize)},beforeDestroy(){window.removeEventListener("resize",this.handleResize)},methods:{handleSelect(s){this.changeGraph(s.name)},querySearch(s,e){var a=this.searchList,o=s?a.filter(this.createFilter(s)):a;e(o)},createFilter(s){return e=>e.value.toLowerCase().indexOf(s.toLowerCase())===0},getGraphEntityScheme(){const s={page:1,pageSize:1e3,taskId:this.taskKeyId};F(s).then(e=>{this.searchList=e.data,this.searchList.map(a=>{a.value=a.name})})},handleResize(){this.windowsSizeTimer&&clearTimeout(this.windowsSizeTimer),this.windowsSizeTimer=setTimeout(()=>{this.atlasChart.resize()},300)},changeGraph(s){const e=this.atlasChart.getOption();let a=e.series[0].nodes.map(i=>i.name),o=null;if(a.includes(s))o=e.series[0].nodes.map(i=>i.name===s?{...i,itemStyle:{}}:{...i,itemStyle:{opacity:.2}});else return;const t={...e,series:[{...e.series[0],nodes:o}]};this.atlasChart.setOption(t)},EchartsInit(){function s(a){var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null}function e(a,o){if(a.startsWith("#")){var t=s(a);return`rgba(${t.r}, ${t.g}, ${t.b}, ${o})`}else if(a.startsWith("rgb(")){var i=a.match(/\d+/g);return`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${o})`}else return a}this.atlasChart=L(this.$refs.atlasChart),this.atlasChart.setOption({series:[{type:"graph",roam:!0,scaleLimit:{min:.6},animation:!1,animationDuration:0,draggable:!0,layout:"force",force:{repulsion:1e3,edgeLength:200,friction:.2},itemStyle:{borderColor:"transparent",borderWidth:1},label:{fontSize:12,color:"#000",fontFamily:"PingFang SC",normal:{show:!0,formatter:function(a){return a.data.name.length>4?a.data.name.substr(0,4)+"...":a.data.name}},emphasis:{show:!0,formatter:"{b}",overflow:"break",lineHeight:15,itemStyle:{borderColor:function(a){var o=a.color;return e(o,.5)},borderWidth:10}}},edgeLabel:{show:!0,fontSize:12,fontWeight:900,lineHeight:15,fontFamily:"PingFang SC",color:"#adadadeb",formatter:a=>a.value},lineStyle:{opacity:1,width:2,color:"#adadadeb"},edgeSymbol:["none","arrow"],edgeSymbolSize:8,nodes:[],links:[]}]}),this.atlasChart.on("click",a=>{event.stopPropagation(),a.dataType=="node"&&(this.nowNodeInfo={type:a.data.category,name:a.data.name,id:a.data.nodeid,x:a.event.offsetX,y:a.event.offsetY})}),this.atlasChart.getZr().on("click",a=>{if(event.stopPropagation(),!a.target){this.nowNodeInfo=null,this.searchQuery="";const o=this.atlasChart.getOption(),t=o.series[0].nodes.map(l=>({...l,itemStyle:{opacity:1}})),i={...o,series:[{...o.series[0],nodes:t}]};this.atlasChart.setOption(i)}})},dataItemStyle(s,e,a){return{color:{type:"radial",x:.5,y:.5,r:.4,globalCoord:!1,colorStops:[{offset:0,color:s},{offset:1,color:e}]},borderColor:a,borderWidth:6,borderType:"solid"}},indexColorGET(s,e){let a=[["#EA8C82","#E46A5E","#D3C8DA"],["#E2B0AA","#EA9E8C","#D4D4E4"],["#EACD92","#F3C263","#D9DCDC"],["#AECCD7","#A4C6CB","#C2D7EF"],["#C48ABB","#C46FA5","#C9C7E9"],["#E3CFCD","#EDCABE","#CDD7EF"],["#B7D8F7","#B2D7F5","#D0E3FB"],["#A8DEE8","#9CDCE2","#BFDCF6"]],o=[{level:0,size:110},{level:1,size:70}],t=e>1?["#8CC5FF","#66B1FF","#B3D8FF"]:a[s],i=e>1?76:o.filter(l=>l.level==e)[0].size;return{color:t,size:i}},update(){this.EchartsData.nodes.forEach((e,a)=>{let o=this.indexColorGET(a,e.level);e.symbolSize=o.size,e.label={width:o.size-10}});let s=this.atlasChart.getOption();s.series[0].nodes=this.EchartsData.nodes,s.series[0].links=this.EchartsData.links,s.series[0].categories=this.EchartsData.categories,this.searchList=this.EchartsData.nodes,this.searchList.map(e=>{e.value=e.name}),this.atlasChart.setOption(s)},sonNodesGET(s,e){let a=[];return s.forEach(o=>{o.source==e&&(a.push(o.target),a=a.concat(this.sonNodesGET(s,o.target)))}),a},nodesHandle(s,e,a=!0){if(a)this.nodesGET(s,e);else{this.nodeDetailsShow=!1;let o=this.showNode.findIndex(h=>h==s);this.showNode.splice(o,1);let t=this.sonNodesGET(this.EchartsData.links,s),i=this.EchartsData.nodes.filter(h=>!t.includes(h.name)),l=this.EchartsData.links.filter(h=>!t.includes(h.target)),D=this.EchartsData.nodes.filter(h=>h.name==s)[0].level;this.showNode.forEach((h,v)=>{this.EchartsData.nodes.filter(r=>r.name==h)[0].level>D&&(this.showNode=this.showNode.filter(r=>r!=h))}),this.EchartsData.nodes=i,this.searchList=i,this.searchList.map(h=>{h.value=h.name}),this.EchartsData.links=l,this.update()}},filterBidirectionalLinks(s){const e=new Map,a=[];return s.forEach(o=>{const t=`${o.source}-${o.target}`,i=`${o.target}-${o.source}`;!e.has(t)&&!e.has(i)&&(a.push(o),e.set(t,!0))}),a},nodesGET(s,e){if(this.$refs.Load.showLoad(!0,"获取数据..."),e){let o={name:e.name,type:e.type,taskId:this.taskKeyId};N(o).then(t=>{this.EchartsData.categories=t.categories,this.$refs.Load.showLoad(!1),t.nodes.length>0?this.showNode.push(s):this.$refs.Hint.showHint(s+"没有其他子节点了"),t.nodes.forEach(i=>{s=="乌海市取水许可知识图谱"?i.level=1:i.level=this.EchartsData.nodes.filter(l=>l.name==s)[0].level+1,i.name=="乌海市取水许可知识图谱"&&(i.level=0),this.EchartsData.nodes.some(l=>l.name===i.name)||this.EchartsData.nodes.push(i)}),t.links.forEach(i=>{this.EchartsData.links.some(l=>l.target===i.target)||this.EchartsData.links.push(i),t.nodes.forEach(function(l){i.target==l.nodeid&&(i.target=l.name),i.source==l.nodeid&&(i.source=l.name)})}),this.EchartsData.links=this.filterBidirectionalLinks(this.EchartsData.links),this.update()});return}const a={taskId:this.taskKeyId,total:1e3};T(a).then(o=>{this.searchList=o.nodes,this.searchList.map(t=>{t.value=t.name}),this.EchartsData.categories=o.categories,this.$refs.Load.showLoad(!1),o.nodes.length>0?this.showNode.push(s):this.$refs.Hint.showHint(s+"没有其他子节点了"),o.nodes.forEach(t=>{s=="乌海市取水许可知识图谱"?t.level=1:t.level=this.EchartsData.nodes.filter(i=>i.name==s)[0].level+1,t.name=="乌海市取水许可知识图谱"&&(t.level=0),this.EchartsData.nodes.some(i=>i.name===t.name)||this.EchartsData.nodes.push(t)}),o.links.forEach(t=>{this.EchartsData.links.some(i=>i.target===t.target)||this.EchartsData.links.push(t),o.nodes.forEach(function(i){t.target==i.nodeid&&(t.target=i.name),t.source==i.nodeid&&(t.source=i.name)})}),this.update()}).catch(o=>{this.$refs.Load.showLoad(!1),this.$refs.Hint.showHint("获取数据失败")})},nodeDetails(s){this.$refs.Load.showLoad(!0,"获取数据...");let e={taskId:this.taskKeyId,name:s.name,type:s.type};z(e).then(a=>{this.$refs.Load.showLoad(!1),this.nodeDetailsData=a,this.nodeDetailsShow=!0}).catch(a=>{this.$refs.Load.showLoad(!1),this.$refs.Hint.showHint("获取实体详情失败")})},getGraphTask(){B({taskType:3,status:5}).then(e=>{this.taskList=e.data,this.taskList.length>0&&(this.taskKeyId=this.taskList[0].id,this.nodesHandle("乌海市取水许可知识图谱"))})},selectTaskList(s){this.taskKeyId=s,this.EchartsData={nodes:[],links:[],categories:[]},this.showNode=[],this.nodesHandle("乌海市取水许可知识图谱")}}},G={class:"search-box z-index w-20% h-200px position-absolute"},O={class:"position-relative"},V={class:"title"},K={class:"type"},R={class:"handle"},Q={key:1,class:"nodeDetails"},W={class:"typeText"},q={class:"list"},P={class:"flex items-baseline mb-15px"},U={class:"flex-1 f-3"},$={class:"text-gray-400 mr-20px f-blue"},M={class:"flex-1 f-3"},j={class:"text-gray-400 mr-20px f-blue"},X={class:"flex-1 f-3"},Y={class:"search-box w-20% h-200px position-absolute right-0 flex-col items-end flex"};function Z(s,e,a,o,t,i){const l=f("el-autocomplete"),D=f("Load"),h=f("Hint"),v=f("el-option"),C=f("el-select");return d(),u("div",{class:"container-atlas flex",onClick:e[5]||(e[5]=r=>t.nowNodeInfo=null)},[n("div",G,[e[6]||(e[6]=n("div",{class:"title-box"}," 图谱探索 ",-1)),n("div",O,[g(l,{class:"inline-input",icon:"el-icon-search",modelValue:t.searchQuery,"onUpdate:modelValue":e[0]||(e[0]=r=>t.searchQuery=r),"fetch-suggestions":i.querySearch,placeholder:"请输入内容","trigger-on-focus":!1,onSelect:i.handleSelect},null,8,["modelValue","fetch-suggestions","onSelect"])])]),n("div",{id:"graphId",class:x(["atlasChart w-80%",{atlasChartSize:t.nodeDetailsShow}]),ref:"atlasChart"},null,2),g(D,{ref:"Load"},null,512),g(h,{ref:"Hint"},null,512),t.nowNodeInfo?(d(),u("div",{key:0,class:"nowNodeInfo",style:b({left:t.nowNodeInfo.x+"px",top:t.nowNodeInfo.y+"px"})},[n("div",V,c(t.nowNodeInfo.name),1),n("div",K,[e[7]||(e[7]=S("类型 : ")),n("span",null,c(t.nowNodeInfo.type),1)]),n("div",R,[n("li",{onClick:e[1]||(e[1]=r=>i.nodeDetails(t.nowNodeInfo))},"实体详情"),n("li",{onClick:e[2]||(e[2]=r=>i.nodesHandle(t.nowNodeInfo.name,t.nowNodeInfo,!t.showNode.includes(t.nowNodeInfo.name)))},c(t.showNode.includes(t.nowNodeInfo.name)?"隐藏子节点":"显示子节点"),1),e[8]||(e[8]=n("li",null,"取消",-1))])],4)):w("",!0),t.nodeDetailsShow?(d(),u("div",Q,[n("div",{class:"fold",onClick:e[3]||(e[3]=r=>t.nodeDetailsShow=!1)},e[9]||(e[9]=[n("span",{class:"iconfont"},"",-1)])),n("div",W,[e[11]||(e[11]=n("div",{class:"title"},[n("img",{src:H}),n("i",null,c("节点信息"))],-1)),n("div",q,[n("div",P,[e[10]||(e[10]=n("div",{class:"text-gray-400 mr-20px f-blue"},"名称:",-1)),n("div",U,c(t.nodeDetailsData.name),1)]),String(t.nodeDetailsData.groupRelations)!="{}"?(d(!0),u(y,{key:0},E(t.nodeDetailsData.groupRelations||{},(r,m)=>(d(),u("div",{class:"flex items-baseline",key:m+"relations"},[n("div",$,c(m),1),n("div",M,c(r),1)]))),128)):w("",!0),t.nodeDetailsData.attlist.length>0?(d(!0),u(y,{key:1},E(t.nodeDetailsData.attlist,(r,m)=>(d(),u("div",{key:m,class:"flex items-baseline mb-15px"},[n("div",j,c(r.attname)+":",1),n("div",X,c(r.atttvalue),1)]))),128)):w("",!0)])])])):w("",!0),n("div",Y,[e[12]||(e[12]=n("div",{class:"title-box"}," 图谱选择 ",-1)),g(C,{class:"inline-input",modelValue:t.taskKeyId,"onUpdate:modelValue":e[4]||(e[4]=r=>t.taskKeyId=r),placeholder:"请选择",onChange:i.selectTaskList},{default:_(()=>[(d(!0),u(y,null,E(t.taskList,r=>(d(),I(v,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])])])}const ae=k(A,[["render",Z],["__scopeId","data-v-4a9592c3"]]);export{ae as default};
